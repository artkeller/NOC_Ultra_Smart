<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Connectivity Diagnose Monitor</title>

<style>
body {
  font-family: system-ui, sans-serif;
  background:#111;
  color:#eee;
  padding:40px;
  display:flex;
  align-items:center;
  gap:20px;
}

.led {
  width:22px;
  height:22px;
  border-radius:50%;
  background:#555;
}

.gray    { background:#777; }
.violet  { background:#aa66ff; }
.green   { background:#00ff00; box-shadow:0 0 12px #00ff00; }
.yellow  { background:#ffd000; box-shadow:0 0 12px #ffd000; }
.red     { background:#ff0000; box-shadow:0 0 12px #ff0000; }
.redblink {
  background:#ff0000;
  animation:blink 1s infinite;
}

@keyframes blink {
  0%,100% { opacity:1 }
  50% { opacity:0.3 }
}

.info {
  font-size:0.9rem;
  opacity:0.85;
}
</style>
</head>

<body>

<div class="led gray" id="led"></div>

<div>
  <div id="status">Initialisierung…</div>
  <div class="info" id="details"></div>
</div>

<script type="module">

/* ===== Konfiguration ===== */
const TRACKING_URL = "https://httpbin.org/post" /* "https://8.8.8.8" */;
const TIMEOUT_MS = 5000;

/* ===== UI ===== */

const led = document.getElementById("led");
const status = document.getElementById("status");
const details = document.getElementById("details");

function setState(css, text, info="") {
  led.className = "led " + css;
  status.textContent = text;
  details.textContent = info;
}

/* ===== URL Klassifikation ===== */

function analyzeURL(url) {

  if (!url || url.trim() === "")
    return { type:"empty" };

  try {
    const u = new URL(url);

    if (u.protocol !== "http:" && u.protocol !== "https:")
      return { type:"schema", protocol:u.protocol };

    return { type:"valid" };

  } catch {
    return { type:"invalid" };
  }
}

/* ===== Haupttest ===== */

async function runTest() {

  const urlCheck = analyzeURL(TRACKING_URL);

  if (urlCheck.type === "empty") {
    setState("gray", "Keine URL konfiguriert");
    return;
  }

  if (urlCheck.type === "invalid") {
    setState("violet", "URL ungültig");
    return;
  }

  if (urlCheck.type === "schema") {
    setState("violet", "Nicht unterstütztes Schema",
      urlCheck.protocol);
    return;
  }

  if (!navigator.onLine) {
    setState("redblink", "Kein Netzwerk");
    return;
  }

  const start = performance.now();

  try {

    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), TIMEOUT_MS);

    const response = await fetch(TRACKING_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ timestamp:Date.now() }),
      signal: controller.signal
    });

    clearTimeout(timeout);

    if (!response.ok) {
      setState("yellow",
        "HTTP Fehler",
        "Status: " + response.status);
      return;
    }

    const latency = Math.round(performance.now() - start);

    setState("green",
      "Server erreichbar",
      "Antwortzeit: " + latency + " ms");

  } catch (err) {

    if (err.name === "AbortError") {
      setState("red",
        "Timeout",
        "Server reagiert nicht innerhalb " + TIMEOUT_MS + " ms");
      return;
    }

    if (err instanceof TypeError) {
      setState("red",
        "Netzwerkfehler",
        "DNS / TCP / TLS fehlgeschlagen");
      return;
    }

    setState("red",
      "Unbekannter Fehler",
      err.message);
  }
}

/* ===== Events ===== */

window.addEventListener("online", runTest);
window.addEventListener("offline", () => {
  setState("redblink", "Netzwerk getrennt");
});

/* ===== Start ===== */

runTest();

</script>

</body>
</html>
